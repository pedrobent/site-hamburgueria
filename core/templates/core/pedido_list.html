{% extends 'core/base.html' %}
{% load custom_filters %}

{% block title %}Lista de Pedidos{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">Pedidos</h2>
        </div>
    </div>

    <div class="row" id="pedidos-container">
        {% for pedido in pedidos %}
        <div class="col-md-4 mb-4">
            <div class="card pedido-card status-{{ pedido.status }}">
                <div class="card-header bg-{{ pedido.status }}">
                    <h5 class="card-title mb-0 text-white">Pedido #{{ pedido.numero_pedido }}</h5>
                </div>
                <div class="card-body">
                    <h6 class="card-subtitle mb-2">{{ pedido.cliente }}</h6>
                    {% if pedido.mesa %}
                    <p class="card-text"><strong>Mesa:</strong> {{ pedido.mesa }}</p>
                    {% endif %}
                    
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Qtd</th>
                                    <th>Preço</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in pedido.itens_pedido.all %}
                                <tr>
                                    <td>{{ item.produto.nome }}</td>
                                    <td>{{ item.quantidade }}</td>
                                    <td>R$ {{ item.preco_unitario }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="2" class="text-end"><strong>Total:</strong></td>
                                    <td><strong>R$ {{ pedido.valor_total|floatformat:2 }}</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    {% if pedido.observacoes %}
                    <p class="card-text"><strong>Observações:</strong> {{ pedido.observacoes }}</p>
                    {% endif %}
                    
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <span class="badge bg-{{ pedido.status }}">{{ pedido.get_status_display }}</span>
                        <small class="text-muted">{{ pedido.data_criacao|date:"d/m/Y H:i" }}</small>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-sm btn-primary atualizar-status" 
                                data-pedido-id="{{ pedido.id }}"
                                data-status="preparando">
                            Preparar
                        </button>
                        <button class="btn btn-sm btn-success atualizar-status" 
                                data-pedido-id="{{ pedido.id }}"
                                data-status="finalizado">
                            Finalizar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-info">
                Nenhum pedido encontrado.
            </div>
        </div>
        {% endfor %}
    </div>
</div>

{% csrf_token %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const botoes = document.querySelectorAll('.atualizar-status');
    botoes.forEach(function(botao) {
        botao.addEventListener('click', function() {
            const pedidoId = this.getAttribute('data-pedido-id');
            const novoStatus = this.getAttribute('data-status');
            
            fetch(`/api/pedidos/${pedidoId}/atualizar_status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ status: novoStatus })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                } else {
                    alert('Erro ao atualizar status do pedido');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao atualizar status do pedido');
            });
        });
    });
});
</script>
{% endblock %} 